<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CycloBot</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    html, body { height: 100%; }

    body {
      background: #fff;
      color: #111;
      font-family: 'Courier New', Courier, monospace;
      font-size: 13px;
      display: flex;
      flex-direction: column;
    }

    header {
      border-bottom: 2px solid #111;
      padding: .5rem 1rem;
      display: flex;
      align-items: baseline;
      gap: 1.5rem;
      flex-shrink: 0;
    }
    header h1 { font-size: 14px; font-weight: bold; letter-spacing: .05em; }
    header span { font-size: 11px; color: #555; }

    /* ── Main layout ── */
    .layout {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* ── Left panel: parameters ── */
    .left-panel {
      width: 230px;
      flex-shrink: 0;
      border-right: 1px solid #bbb;
      padding: .9rem .85rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: .6rem;
    }

    .param-panel { display: none; flex-direction: column; gap: .55rem; }
    .param-panel.active { display: flex; }

    .param-title { font-size: 12px; font-weight: bold; }
    .param-desc  { font-size: 10px; color: #666; line-height: 1.4; }

    .field { display: flex; flex-direction: column; gap: .15rem; }
    .field label { font-size: 10px; color: #444; }
    .field input {
      background: #fff;
      border: 1px solid #999;
      color: #111;
      font-family: inherit;
      font-size: 12px;
      padding: .25rem .35rem;
      width: 100%;
    }
    .field input:focus { outline: 1px solid #111; }
    .field input.optional { border-style: dashed; }
    .field .hint { font-size: 10px; color: #888; }

    button.submit {
      background: #111;
      border: 1px solid #111;
      color: #fff;
      cursor: pointer;
      font-family: inherit;
      font-size: 12px;
      padding: .3rem .9rem;
      align-self: flex-start;
      margin-top: .2rem;
    }
    button.submit:disabled { opacity: .4; cursor: not-allowed; }
    button.submit:hover:not(:disabled) { background: #333; }

    .status { font-size: 10px; min-height: .9rem; }
    .status.loading { color: #555; }
    .status.error   { color: #b00; white-space: pre-wrap; }
    .status.success { color: #080; }

    /* ── Right panel: tabs + image ── */
    .right-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .tabs {
      display: flex;
      justify-content: flex-end;
      border-bottom: 1px solid #aaa;
      flex-shrink: 0;
    }
    .tab-btn {
      background: none;
      border: 1px solid transparent;
      border-bottom: none;
      color: #666;
      cursor: pointer;
      font-family: inherit;
      font-size: 12px;
      padding: .3rem .85rem;
      margin-bottom: -1px;
    }
    .tab-btn:hover { color: #111; }
    .tab-btn.active {
      color: #111;
      border-color: #aaa;
      border-bottom-color: #fff;
      background: #fff;
    }

    /* ── Image area ── */
    .image-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      overflow: auto;
    }

    .image-area img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      display: none;
      border: 1px solid #ddd;
    }
    .image-area img.visible { display: block; }

    .image-links {
      display: none;
      gap: 1rem;
      margin-top: .4rem;
      font-size: 11px;
    }
    .image-links.visible { display: flex; }
    .image-links a { color: #111; text-decoration: underline; }

    .image-placeholder {
      font-size: 11px;
      color: #bbb;
    }
  </style>
</head>
<body>

<header>
  <h1>CYCLOBOT</h1>
  <span>Satellite Imagery &amp; Model Diagnostics / Deelan Jariwala</span>
</header>

<div class="layout">

  <!-- ── Left: parameter forms ── -->
  <div class="left-panel">

    <div class="param-panel active" id="params-plot">
      <div class="param-title">GOES / Himawari</div>
      <div class="param-desc">GOES-R (16/18/19) and Himawari (8/9) via AWS.</div>
      <div class="field">
        <label>SATELLITE</label>
        <input id="plot-satellite" type="text" placeholder="16, 18, H9" />
        <span class="hint">16 18 19 H8 H9</span>
      </div>
      <div class="field">
        <label>DATE</label>
        <input id="plot-date" type="text" placeholder="MM/DD/YYYY" />
      </div>
      <div class="field">
        <label>TIME (UTC)</label>
        <input id="plot-time" type="text" placeholder="1800" maxlength="4" />
      </div>
      <div class="field">
        <label>LAT</label>
        <input id="plot-lat" type="text" placeholder="25.0" />
      </div>
      <div class="field">
        <label>LON</label>
        <input id="plot-lon" type="text" placeholder="-80.0" />
      </div>
      <div class="field">
        <label>BAND</label>
        <input id="plot-band" type="text" placeholder="13" />
        <span class="hint">channel number</span>
      </div>
      <div class="field">
        <label>COLORMAP</label>
        <input id="plot-cmap" type="text" placeholder="irg" class="optional" />
        <span class="hint">optional</span>
      </div>
      <div class="field">
        <label>ZOOM</label>
        <input id="plot-zoom" type="text" placeholder="2" class="optional" />
        <span class="hint">optional</span>
      </div>
      <button class="submit" onclick="runPlot()">run</button>
      <div class="status" id="plot-status"></div>
    </div>

    <div class="param-panel" id="params-mcfetch">
      <div class="param-title">McIDAS</div>
      <div class="param-desc">Older geostationary archive via SSEC. Covers GOES 1–15, GMS, MTSAT, early Himawari.</div>
      <div class="field">
        <label>SATELLITE</label>
        <input id="mc-satellite" type="text" placeholder="G8, G12, 8" />
      </div>
      <div class="field">
        <label>DATE</label>
        <input id="mc-date" type="text" placeholder="MM/DD/YYYY" />
      </div>
      <div class="field">
        <label>TIME (UTC)</label>
        <input id="mc-time" type="text" placeholder="1800" maxlength="4" />
      </div>
      <div class="field">
        <label>LAT</label>
        <input id="mc-lat" type="text" placeholder="25.0" />
      </div>
      <div class="field">
        <label>LON</label>
        <input id="mc-lon" type="text" placeholder="-80.0" />
      </div>
      <div class="field">
        <label>BAND</label>
        <input id="mc-band" type="text" placeholder="4" />
        <span class="hint">3=WV  4=IR</span>
      </div>
      <div class="field">
        <label>COLORMAP</label>
        <input id="mc-cmap" type="text" placeholder="irg" class="optional" />
        <span class="hint">optional</span>
      </div>
      <div class="field">
        <label>ZOOM (max 2)</label>
        <input id="mc-zoom" type="text" placeholder="2" class="optional" />
        <span class="hint">optional</span>
      </div>
      <button class="submit" onclick="runMcfetch()">run</button>
      <div class="status" id="mc-status"></div>
    </div>

    <div class="param-panel" id="params-hafs">
      <div class="param-title">HAFS</div>
      <div class="param-desc">Hurricane Analysis and Forecast System (HAFS-A/B) real-time output.</div>
      <div class="field">
        <label>STORM</label>
        <input id="hafs-storm" type="text" placeholder="09l" />
        <span class="hint">NNX format</span>
      </div>
      <div class="field">
        <label>INIT DATE</label>
        <input id="hafs-date" type="text" placeholder="MM/DD/YYYY" />
      </div>
      <div class="field">
        <label>INIT HOUR (UTC)</label>
        <input id="hafs-init" type="text" placeholder="12" maxlength="2" />
        <span class="hint">00 06 12 18</span>
      </div>
      <div class="field">
        <label>FCST HOUR</label>
        <input id="hafs-fhour" type="text" placeholder="024" maxlength="3" />
        <span class="hint">e.g. 024 048</span>
      </div>
      <div class="field">
        <label>VARIABLE</label>
        <input id="hafs-var" type="text" placeholder="diseq" />
        <span class="hint">temp wind rh vort pwat cape sst slp shear…</span>
      </div>
      <div class="field">
        <label>LEVEL (hPa)</label>
        <input id="hafs-level" type="text" placeholder="850" class="optional" />
        <span class="hint">optional</span>
      </div>
      <div class="field">
        <label>MODEL</label>
        <input id="hafs-model" type="text" placeholder="a" maxlength="1" class="optional" />
        <span class="hint">a or b</span>
      </div>
      <div class="field">
        <label>DOMAIN</label>
        <input id="hafs-domain" type="text" placeholder="storm" class="optional" />
        <span class="hint">storm or synoptic</span>
      </div>
      <button class="submit" onclick="runHafs()">run</button>
      <div class="status" id="hafs-status"></div>
    </div>

  </div><!-- /left-panel -->

  <!-- ── Right: tabs + image ── -->
  <div class="right-panel">
    <div class="tabs">
      <button class="tab-btn active" data-tab="plot">GOES / Himawari</button>
      <button class="tab-btn"        data-tab="mcfetch">McIDAS</button>
      <button class="tab-btn"        data-tab="hafs">HAFS</button>
    </div>
    <div class="image-area">
      <span class="image-placeholder" id="img-placeholder">output will appear here</span>
      <img id="result-img" src="" alt="" />
      <div class="image-links" id="result-links">
        <a id="link-img"  href="#" target="_blank">open image</a>
        <a id="link-extra" href="#" target="_blank" style="display:none"></a>
      </div>
    </div>
  </div>

</div><!-- /layout -->

<script>
  // Tab switching
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.param-panel').forEach(p => p.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('params-' + btn.dataset.tab).classList.add('active');
    });
  });

  const API_BASE = 'https://cycloweb.onrender.com';

  function val(id) { return document.getElementById(id).value.trim(); }

  function setStatus(prefix, type, msg) {
    const el = document.getElementById(prefix + '-status');
    el.className = 'status ' + type;
    el.textContent = msg;
  }

  function showImage(imgUrl, extraUrl, extraLabel) {
    document.getElementById('img-placeholder').style.display = 'none';
    const img = document.getElementById('result-img');
    img.src = imgUrl;
    img.classList.add('visible');
    document.getElementById('link-img').href = imgUrl;
    const links = document.getElementById('result-links');
    links.classList.add('visible');
    const extra = document.getElementById('link-extra');
    if (extraUrl) {
      extra.href = extraUrl;
      extra.textContent = extraLabel;
      extra.style.display = '';
    } else {
      extra.style.display = 'none';
    }
  }

  function setLoading(prefix, btn) {
    setStatus(prefix, 'loading', 'working...');
    btn.disabled = true;
  }

  function setDone(prefix, btn) {
    setStatus(prefix, 'success', 'done.');
    btn.disabled = false;
  }

  function setError(prefix, btn, detail) {
    setStatus(prefix, 'error', detail);
    btn.disabled = false;
  }

  async function callAPI(endpoint, params) {
    const url = new URL(API_BASE + endpoint);
    Object.entries(params).forEach(([k, v]) => { if (v) url.searchParams.set(k, v); });
    const res = await fetch(url);
    if (!res.ok) {
      const body = await res.json().catch(() => ({ detail: res.statusText }));
      throw new Error(body.detail || res.statusText);
    }
    return res.json();
  }

  async function runPlot() {
    const btn = event.target;
    setLoading('plot', btn);
    try {
      const data = await callAPI('/plot', {
        satellite: val('plot-satellite'),
        date:      val('plot-date'),
        time:      val('plot-time'),
        lat:       val('plot-lat'),
        lon:       val('plot-lon'),
        band:      val('plot-band'),
        cmap:      val('plot-cmap'),
        zoom:      val('plot-zoom'),
      });
      showImage(API_BASE + data.image_url + '?t=' + Date.now(), API_BASE + data.nc_url, 'download .nc');
      setDone('plot', btn);
    } catch (e) { setError('plot', btn, e.message); }
  }

  async function runMcfetch() {
    const btn = event.target;
    setLoading('mc', btn);
    try {
      const data = await callAPI('/mcfetch', {
        satellite: val('mc-satellite'),
        date:      val('mc-date'),
        time:      val('mc-time'),
        lat:       val('mc-lat'),
        lon:       val('mc-lon'),
        band:      val('mc-band'),
        cmap:      val('mc-cmap'),
        zoom:      val('mc-zoom'),
      });
      showImage(API_BASE + data.image_url + '?t=' + Date.now(), API_BASE + data.nc_url, 'download .nc');
      setDone('mc', btn);
    } catch (e) { setError('mc', btn, e.message); }
  }

  async function runHafs() {
    const btn = event.target;
    setLoading('hafs', btn);
    try {
      const data = await callAPI('/hafs', {
        storm:  val('hafs-storm'),
        date:   val('hafs-date'),
        init:   val('hafs-init'),
        fhour:  val('hafs-fhour'),
        var:    val('hafs-var'),
        level:  val('hafs-level'),
        model:  val('hafs-model'),
        domain: val('hafs-domain'),
      });
      showImage(API_BASE + data.image_url + '?t=' + Date.now(), null, null);
      setDone('hafs', btn);
    } catch (e) { setError('hafs', btn, e.message); }
  }
</script>
</body>
</html>
